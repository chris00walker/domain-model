# EFI DDD Automation Workflow

This document explains how the **automated domain-modeling toolkit** under `DDD_Artefacts/scripts` turns raw planning inputs into living Event-Storming artefacts.

---

## 1. Prerequisites

| Requirement | Purpose |
|-------------|---------|
| **Node.js v18+** | Runs TypeScript scripts (via `tsx`). |
| **OPENAI_API_KEY** (env) | Enables GPT-generated contributions. If omitted, fallback stubs are produced. |
| **LLM_DEBUG=1** (optional) | Prints raw LLM JSON for troubleshooting. |

```bash
# Example
export OPENAI_API_KEY="sk-…"
```

---

## 2. Key Input Files

| Path | Role |
|------|------|
| `DDD_Artefacts/docs/analysis/phase1/event-storming-session-prep.md` | Session prep pack (generated by `npm run session`). |
| `DDD_Artefacts/automation/roster.yaml` | Master list of expert agents + meta options. |
| `DDD_Artefacts/automation/template.md` | *(optional)* guideline for human-written briefs. |

---

## 3. Primary npm Scripts

| Script | Under the hood | Purpose |
|--------|----------------|---------|
| `npm run ddd` | `cli all` | Full pipeline: gap scan ➜ brief ➜ matrix ➜ session prep ➜ implementation plan ➜ virtual storm |
| `npm run session` | `cli session` | Create **event-storming-session-prep.md** with checklists, agenda & roster |
| `npm run plan` | `cli plan` | Generate **implementation-plan.md** (effort estimates, phasing, risks) |
| `npm run storm` | `phase2/cli/virtualStorm.ts` | Run AI-assisted Event-Storming session using latest prep |
| `npm run brief` | `cli brief` | Regenerate AI validation briefs |
| `npm run matrix` | `cli matrix` | Produce dependency/context matrix (PlantUML) |
| `npm run gaps` | `cli gaps` | Scan for missing contexts |

> All scripts ultimately call the TypeScript CLI declared in `DDD_Artefacts/scripts/cli.ts`.

---

## 4. End-to-End Flow

```text
┌────────────┐   scanGaps   ┌──────────────┐  generateBrief  ┌──────────────┐
│  PRD / Src │────────────▶│  gaps.md      │───────────────▶│  *brief*.md   │
└────────────┘              └──────────────┘                 └──────────────┘
       ▲                         │ buildMatrix                     │
       │                         ▼                                 ▼
 event-storming-prep.md   context_matrix.md                domain-orchestration-plan.md
       │                         │ orchestrateDomain               │ (human review)
       ▼                         ▼                                 ▼
 runVirtualStormSession ◀────── virtual-storm/ ───────────────▶ versioned context-map
```

1. **scanGaps** – locate undocumented or unimplemented contexts.  
2. **generateBrief** – draft AI validation briefs for each gap.  
3. **buildMatrix** – create dependency/context matrix (PlantUML).  
4. **prepareSession** – assemble session-prep pack (agenda, questions, roster).  
5. **planImplementation** – generate phased implementation roadmap.  
6. **virtualStorm** – AI-assisted brainstorming; updates context map & diagrams.

---

## 5. Output Artefacts

| Path | Content |
|------|---------|
| `DDD_Artefacts/docs/analysis/phase1/event-storming-session-prep.md` | Session preparation pack (agenda, questions, roster). |
| `DDD_Artefacts/docs/analysis/phase1/implementation-plan.md` | Phased implementation roadmap. |
| `DDD_Artefacts/docs/analysis/virtual-storm/*.json` | Enriched events, commands, integration points. |
| `DDD_Artefacts/docs/analysis/virtual-storm/*.puml` | Mini PlantUML diagrams per context. |
| `DDD_Artefacts/storm-summary.csv` | One-line metrics per context. |

---

## 6. Troubleshooting

• **No AI contributions** ➜ Check `OPENAI_API_KEY` or network.
• **Spammy logs** ➜ Ensure `LLM_DEBUG` is unset.
• **Missing agents** ➜ Verify `contexts:` fields in `roster.yaml`.
• **TypeScript errors** ➜ Run `npm run build` (all scripts compile TS).

---

## 7. Related ADRs & Docs

* ADR-007 – Hexagonal Modular Monolith
* ADR-008 – Event-Driven Communication
* ADR-002 – Domain Event Patterns (for brainstormed events)
* [Automation Architecture](./ARCHITECTURE.md)

---

*Prepared automatically on first creation; feel free to extend this README with your own notes.*
